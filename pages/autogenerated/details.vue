<template>
  <div class="details-page container">
    <div>
      <div><strong>Requested stops</strong></div>
      <ol>
        <li v-for="(stop, stopIndex) in stops" :key="`${stop.index}, ${stopIndex}`">
          <a href="#" @click.prevent="viewStop(stop)">
            {{stop.description}}
          </a>
        </li>
      </ol>

      <div v-if="this.time !== null">
        <strong>Requested Arrival Time:</strong>
        {{dateformat(this.time, 'h:MM TT', true)}}
      </div>
      
      <hr/>
      
      <div>
        Total number of requests served: <strong>{{relatedRequests && relatedRequests.length}}</strong>
      </div>

      <requests-time-histogram :requests="relatedRequests"
        :width="320" :height="350">
      </requests-time-histogram>
    </div>
    <GmapMap class="gmap"
        :center="{lat: 1.38, lng: 103.8}" :zoom="11"
        :options="{gestureHandling: 'greedy'}"
        ref="proposed-route-map">

      <RoutePathAndStops :stops="stops" />
      <SuggestionMarker v-for="(req, index) in relatedRequests"
        :key="`board-${index}`"
        :position="req.start" />
      <SuggestionMarker v-for="(req, index) in relatedRequests"
        :key="`alight-${index}`"
        :position="req.end" />
    </GmapMap>
  </div>
</template>

<style lang="scss">
 .details-page {
   min-height: 400px;
   display: flex;
   flex-direction: row;

   .gmap {
     flex: 1 1 auto;
   }
 }
</style>

<script>
import {keyBy} from 'lodash'
import axios from 'axios'
import dateformat from 'dateformat'
import querystring from 'querystring'
import RoutePathAndStops from '~/components/autogenerated/RoutePathAndStops'
import SuggestionMarker from '~/components/autogenerated/SuggestionMarker'
import RequestsTimeHistogram from '~/components/suggest/RequestsTimeHistogram'

export default {
  layout: 'landing',

  components: {
    RequestsTimeHistogram, RoutePathAndStops, SuggestionMarker
  },

  async asyncData (params) {
    const stopIndices = params.query.stops.split(',').map(s => parseInt(s))
    const path = stopIndices.join('/')

    const [stopDetailsReq, matchingRequestsReq] = await Promise.all([
      axios.get(
        `${process.env.beelineRoutingServer}/bus_stops`
      ),
      axios.get(
        `${process.env.beelineRoutingServer}/path_requests/${path}?` + querystring.stringify({
          maxDistance: 400, /* Should match setting in autogenerated.vue */
        })
      )
    ])

    return {
      allStops: stopDetailsReq.data,
      relatedRequests: matchingRequestsReq.data,
    }
  },

  data () {
    return {
      allStops: null,
      relatedRequests: null,
    }
  },

  computed: {
    allStopsById () {
      return this.allStops && keyBy(this.allStops, 'index')
    },

    time () {
      if (this.$route.query.time) {
        return parseInt(this.$route.query.time)
      } else {
        return null
      }
    },

    stops () {
      if (this.allStopsById) {
        return this.$route.query
          .stops.split(',')
          .map(s => this.allStopsById[parseInt(s)])
          .map(s => {
            /* oops something is funny in our API */
            s.lat = s.coordinates[1]
            s.lng = s.coordinates[0]
            return s
          })
      }
    },

    dateformat: () => dateformat,
  },

  methods: {
    viewStop (stop) {
      const {lat, lng} = stop
      this.$refs['proposed-route-map'].panTo({lat: parseFloat(lat), lng: parseFloat(lng)})
      if (this.$refs['proposed-route-map'].$mapObject.getZoom() < 15) {
        this.$refs['proposed-route-map'].$mapObject.setZoom(17)
      }
    },
  }
}

</script>
